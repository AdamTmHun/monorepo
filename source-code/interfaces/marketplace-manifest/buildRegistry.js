import fs from "node:fs/promises"

async function main() {
	const registry = JSON.parse(await fs.readFile("./registry.json", "utf-8"))
	/** @type {import("./src/schema.js").MarketplaceManifest[]} */
	const manifests = [...registry.manifests]
	const marketplaceItems = []

	for (const manifest of manifests) {
		const data = JSON.parse(await fs.readFile(manifest, "utf-8"))

		const marketplaceItem = data

		marketplaceItems.push(marketplaceItem)
	}

	/* Sort the registry by type */
	const typeOrder = { app: -1, library: 1 }

	marketplaceItems.sort((a, b) => (typeOrder[a.type] || 0) - (typeOrder[b.type] || 0))

	await fs.writeFile(
		"./src/registry.ts",
		`//! Do not edit this file manually. It is automatically generated based on the contents of the registry.json file.

        export const registry = ${JSON.stringify(marketplaceItems, undefined, "\t")}`,
	)
}

main()
